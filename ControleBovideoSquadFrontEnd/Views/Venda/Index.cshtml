<div class="container col-xxl-8 px-4 py-4">
  <h1 class="display-5 text-center">Lista de registro de vendas</h1>
  <p class="blockquote-footer text-center">
    Selecione uma venda para acessar as informações
  </p>
</div>
<button type="button" data-bs-toggle="modal" href="#adicionarVenda" role="button" class="btn btn-success col-md-3 mt-2">Adicionar</button>
<div>
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Quantidade</th>
                <th>Propriedade de origem</th>
                <th>Propriedade de destino</th>
                <th>Finalidade da venda</th>
                <th>Data de venda</th>
                <th>Cancelar</th>
            </tr>
        </thead>
        <tbody data-bind="foreach: vendas">
            <tr>
                <td data-bind="text: $data.quantidade"></td>
                <td data-bind="text: $data.propriedadeOrigem.nome"></td>
                <td data-bind="text: $data.propriedadeDestino.nome"></td>
                <td data-bind="text: $data.finalidadeDeVenda.nome"></td>
                <td data-bind="text: formatarData($data.dataDeVenda)"></td>
                <td><button type="button" class="btn btn-danger" data-bind="click: $parent.cancelarVenda">Cancelar</button></td>
            </tr>
        </tbody>
    </table>
</div>
<!-- Modal de inserção de venda -->
<div class="modal fade" #modal id="adicionarVenda" aria-hidden="true" aria-labelledby="adicionarVendaLabel"
     tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content container">
            <div class="container">
                <div class="modal-header">
                    <button class="btn btn-close" data-bs-dismiss="modal" #buttonClose></button>
                </div>
                <form class="row p-3" id="formVenda" method="POST">
                    <div class="toast-per validationMessage" id="toast">default</div>
                    <div class="col-md-6">
                        <label for="quantidade" class="form-label">Quantidade</label>
                        <input type="number" name="quantidade" class="form-control" data-bind="value: quantidade" id="quantidade">
                    </div>
                    <div class="col-md-4">
                        <label for="especie" class="form-label">Espécie</label>
                        <select data-bind="options: especies,
                            optionsText: 'nome',
                            value: selectedEspecie,
                            optionsValue: 'idEspecie'" name="especie" id="especie" class="form-select">
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="propriedadeOrigem" class="form-label">Propriedade de origem</label>
                        <select data-bind="options: propriedades,
                       optionsText: 'nome',
                       value: selectedPropriedadeOrigem,
                       optionsValue: 'idPropriedade'" name="propriedadeOrigem" id="propriedadeOrigem" class="form-select">
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="propriedadeDestino" class="form-label">Propriedade de destino</label>
                        <select data-bind="options: propriedades,
                            optionsText: 'nome',
                            value: selectedPropriedadeDestino,
                            optionsValue: 'idPropriedade'" name="propriedadeDestino" id="propriedadeDestino" class="form-select">
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="finalidadeVenda" class="form-label">Finalidade de venda</label>
                        <select data-bind="options: finalidadesDeVenda,
                            optionsText: 'nome',
                            optionsValue: 'idFinalidadeDeVenda',
                            value: selectedFinalidadeVenda" name="finalidadeVenda" id="finalidadeVenda" class="form-select">
                        </select>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-success" data-bind="click: salvarVenda">Cadastrar</button>
                        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function formatarData(data){
        var data = new Date(data),
        dia  = data.getDate().toString(),
        diaF = (dia.length == 1) ? '0'+dia : dia,
        mes  = (data.getMonth()+1).toString(), //+1 pois no getMonth Janeiro começa com zero.
        mesF = (mes.length == 1) ? '0'+mes : mes,
        anoF = data.getFullYear();
        return diaF+"/"+mesF+"/"+anoF;
    }

    function mostrarNotficacao(msg, erro = false) {
        const toast = document.getElementById('toast')
        toast.innerHTML = msg
        toast.style.opacity = 1
        setTimeout(() => toast.style.opacity = 0, 2000)
    }

    function appViewModel() {
        const self = this
        const apiUrl = 'https://localhost:7168/api/venda'

        self.quantidade = ko.observable("1").extend({
            required: true,
            min: 1
        })
        self.selectedPropriedadeOrigem = ko.observable("1").extend({
            required: true
        })
        self.selectedPropriedadeDestino = ko.observable("1").extend({
            required: true
        })
        self.selectedFinalidadeVenda = ko.observable("1").extend({
            required: true
        })
        self.selectedEspecie = ko.observable("1").extend({
            required: true
        })

        self.vendas = ko.observableArray()
        self.propriedades = ko.observableArray()
        self.finalidadesDeVenda = ko.observableArray()
        self.especies = ko.observableArray()

        $.get(apiUrl, self.vendas)
        $.get('https://localhost:7168/api/propriedade', self.propriedades)
        $.get('https://localhost:7168/api/finalidadedevenda', self.finalidadesDeVenda)
        $.get('https://localhost:7168/api/especie', self.especies)

        self.salvarVenda = () => {
            let errors = ko.validation.group(this)
            if (errors().length > 0) return errors.showAllMessages()
            const vendaDto = {
                quantidade: Number(self.quantidade()),
                idPropriedadeOrigem: Number(self.selectedPropriedadeOrigem()),
                idPropriedadeDestino: Number(self.selectedPropriedadeDestino()),
                idFinalidadeDeVenda: Number(self.selectedFinalidadeVenda()),
                idEspecie: Number(self.selectedEspecie()),
                dataDeVenda: new Date()
            }

            $.ajax({
                url: apiUrl,
                type: 'POST',
                data: JSON.stringify(vendaDto),
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                success: data => mostrarNotficacao(data),
                error: error => mostrarNotficacao(error.responseJSON[0])
            }).then(() => {
                $.get(apiUrl, self.vendas)
                $('#adicionarVenda').modal('hide')
            })
        }

        self.cancelarVenda = (venda) => {
            $.ajax({
                url: `${apiUrl}/${venda.idVenda}`,
                type: 'DELETE',
                success: data => console.log(data),
                error: error => alert(error.responseText)
            }).then(() => {
                $.get(apiUrl, self.vendas)
                alert('Registro de venda cancelado')
            }).catch(alert)
        }
    }
    
    ko.applyBindings(new appViewModel())
</script>
