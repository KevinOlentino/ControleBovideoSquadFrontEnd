

<div class="container col-xxl-8 px-4 py-4">
    <h1 class="display-5 text-center">Lista de Entrada de animais</h1>
    <p class="blockquote-footer text-center">
        Selecione um animal para acessar as informações
    </p>
</div>
<button type="button" data-bs-toggle="modal" href="#adicionarAnimal" role="button" class="btn btn-success col-md-3 mt-2"> Adicionar</button>
<div>
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Quantidade total</th>
                <th>Quantidade vacinada</th>
                <th>Espécie</th>
                <th>Propriedade</th>
                <th>Remover</th>
            </tr>
        </thead>
        <tbody data-bind="foreach: animais">
            <tr>
                <td data-bind="text: $data.quantidadeTotal"></td>
                <td data-bind="text: $data.quantidadeVacinada"></td>
                <td data-bind="text: $data.especieAnimal.nome"></td>
                <td data-bind="text: $data.propriedadeAnimal.nome"></td>
                <td><button type="button" class="btn btn-danger" data-bind="click: $parent.cancelarEntrada">Cancelar</button></td>
            </tr>
        </tbody>
    </table>
</div>
<!-- Modal de inserção de animais -->
<div class="modal fade" #modal id="adicionarAnimal" aria-hidden="true" aria-labelledby="adicionarAnimalLabel"
     tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content container">
            <div class="container">
                <div class="modal-header">
                    <button class="btn btn-close" data-bs-dismiss="modal" #buttonClose></button>
                </div>
                <form class="row p-3" id="formAnimal" method="POST">
                    <div class="col-md-6">
                        <label for="inputQuantidadeTotal" class="form-label">Quantidade total</label>
                        <input type="number" name="quantidadeTotal" class="form-control" data-bind="value: quantidadeTotal" id="inputQuantidadeTotal" value=0>
                    </div>
                    <div class="col-md-6">
                        <label for="inputQuantidadeVacinada" class="form-label">Quantidade vacinada</label>
                        <input type="number" name="quantidadeVacinada" class="form-control" data-bind="value: quantidadeVacinada" id="inputQuantidadeVacinada" value=0>
                    </div>
                    <div class="col-md-4">
                        <label for="inputEspecie" class="form-label">Espécie</label>
                        <select data-bind="options: especies,
                            optionsText: 'nome',
                            value: selectedEspecie,
                            optionsValue: 'idEspecie'" name="idEspecie" id="inputEspecie" class="form-select">
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="inputPropriedade" class="form-label">Propriedade</label>
                        <select data-bind="options: propriedades,
                            optionsText: 'nome',
                            value: selectedPropriedade,
                            optionsValue: 'idPropriedade'" name="idPropriedade" id="inputPropriedade" class="form-select">
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="inputTipoEntrada" class="form-label">Tipo de entrada</label>
                        <select data-bind="options: tiposDeEntrada,
                            optionsText: 'nome',
                            optionsValue: 'idTipoDeEntrada',
                            value: selectedTipoEntrada" name="idTipoEntrada" id="inputTipoEntrada" class="form-select">
                        </select>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-success" data-bind="click: salvarEntrada">Cadastrar</button>
                        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script>
    function appViewModel() {
        const self = this
        const apiUrl = 'https://localhost:7168/api/animal'

        self.animais = ko.observableArray()
        self.especies = ko.observableArray()
        self.propriedades = ko.observableArray()
        self.tiposDeEntrada = ko.observableArray()

        self.quantidadeTotal = ko.observable("1").extend({
            required: true,
            min: 1,
        })
        self.quantidadeVacinada = ko.observable("0").extend({
            required: true,
            min: 0,
            validation: {
                message: 'O saldo vacinado não pode ser maior que o saldo total',
                validator: value => value <= self.quantidadeTotal()
            }
        })
        self.selectedEspecie = ko.observable("0").extend({
            required: true,
        })
        self.selectedPropriedade = ko.observable("1").extend({
            required: true,
        })
        self.selectedTipoEntrada = ko.observable("1").extend({
            required: true,
        })

        $.get(apiUrl, self.animais)
        $.get('https://localhost:7168/api/especie', self.especies)
        $.get('https://localhost:7168/api/propriedade', self.propriedades)
        $.get('https://localhost:7168/api/tipodeentrada', data => self.tiposDeEntrada(Array.from(data).filter(data => data.nome != 'Compra')))

        self.salvarEntrada = () => {
            let errors = ko.validation.group(this)
            if (errors().length > 0) return errors.showAllMessages()

            const animalDto = {
                quantidadeTotal: Number(self.quantidadeTotal()),
                quantidadeVacinada: Number(self.quantidadeVacinada()),
                idEspecie: Number(self.selectedEspecie()),
                idPropriedade: Number(self.selectedPropriedade()),
                idTipoDeEntrada: Number(self.selectedTipoEntrada()),
                dataDeEntrada: new Date()
            }

            $.ajax({
                url: apiUrl,
                type: 'POST',
                data: JSON.stringify(animalDto),
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                success: data => console.log(data),
                error: error => console.log(error.responseText)
            }).then(() => {
                $.get(apiUrl, self.animais)
                $('#adicionarAnimal').modal('hide')
            })
        }

        self.cancelarEntrada = (animal) => {
            $.ajax({
                url: `${apiUrl}/${animal.idAnimal}`,
                type: 'DELETE',
                success: data => console.log(data),
                error: error => console.log(error.responseText)
            }).then(() => {
                $.get(apiUrl, self.animais)
                alert('Entrada de animal cancelada')
            }).catch(alert)
        }
    }

    ko.applyBindings(new appViewModel())
</script>